

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Code virtual memory &mdash; envytools git documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'git',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="envytools git documentation" href="../index.html" />
    <link rel="up" title="falcon microprocessor" href="index.html" />
    <link rel="next" title="Interrupts" href="intr.html" />
    <link rel="prev" title="Processor control" href="proc.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="intr.html" title="Interrupts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="proc.html" title="Processor control"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">envytools git documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">falcon microprocessor</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="code-virtual-memory">
<span id="falcon-vm"></span><h1><a class="toc-backref" href="#id1">Code virtual memory</a><a class="headerlink" href="#code-virtual-memory" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#code-virtual-memory" id="id1">Code virtual memory</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#tlb-operations-ptlb-vtlb-itlb" id="id3">TLB operations: PTLB, VTLB, ITLB</a><ul>
<li><a class="reference internal" href="#executing-tlb-operations-through-io" id="id4">Executing TLB operations through IO</a></li>
<li><a class="reference internal" href="#tlb-readout-instructions-ptlb-vtlb" id="id5">TLB readout instructions: ptlb, vtlb</a></li>
<li><a class="reference internal" href="#tlb-invalidation-instruction-itlb" id="id6">TLB invalidation instruction: itlb</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vm-usage-on-code-execution" id="id7">VM usage on code execution</a></li>
<li><a class="reference internal" href="#code-upload-and-peeking" id="id8">Code upload and peeking</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>On v3+, the falcon code segment uses primitive paging/VM via simple reverse page
table. The page size is 0x100 bytes.</p>
<p>The physical&lt;-&gt;virtual address mapping information is stored in hidden
TLB memory. There is one TLB cell for each physical code page, and it
specifies the virtual address corresponding to it + some flags. The flags are:</p>
<ul class="simple">
<li>bit 0: usable. Set if page is mapped and complete.</li>
<li>bit 1: busy. Set if page is mapped, but is still being uploaded.</li>
<li>bit 2: secret. Set if page contains secret code. [see <a class="reference internal" href="crypt.html#falcon-crypt"><em>Cryptographic coprocessor</em></a>]</li>
</ul>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">check interaction of secret / usable flags and entering/exitting auth mode</p>
</div>
<p>A TLB entry is considered valid if any of the three flags is set. Whenever
a virtual address is accessed, the TLBs are scanned for a valid entry
with matching virtual address. The physical page whost TLB matched is then
used to complete the access. It&#8217;s an error if no page matched, or if there&#8217;s
more than one match.</p>
<p>The number of physical pages in the code segment can be determined by looking
at <a class="reference internal" href="proc.html#falcon-io-uc-caps"><em>UC_CAPS register</em></a>, bits 0-8. Number of usable
bits in virtual page index can be determined by looking at UC_CAPS2 register,
bits 16-19. Ie. valid virtual addresses of pages are
<cite>0 .. (1 &lt;&lt; (UC_CAPS2[16:19])) * 0x100</cite>.</p>
<p>The TLBs can be modified/accessed in 6 ways:</p>
<ul class="simple">
<li>executing code - reads TLB corresponding to current $pc</li>
<li>PTLB - looks up TLB for a given physical page</li>
<li>VTLB - looks up TLB for a given virtual page</li>
<li>ITLB - invalidates TLB of a given physical page</li>
<li>uploading code via IO access window</li>
<li>uploading code via xfer</li>
</ul>
<p>We&#8217;ll denote the flags of TLB entry of physical page i as TLB[i].flags,
and the virtual page index as TLB[i].virt.</p>
</div>
<div class="section" id="tlb-operations-ptlb-vtlb-itlb">
<h2><a class="toc-backref" href="#id3">TLB operations: PTLB, VTLB, ITLB</a><a class="headerlink" href="#tlb-operations-ptlb-vtlb-itlb" title="Permalink to this headline">¶</a></h2>
<p>These operations take 24-bit parameters, and except for ITLB return a 32-bit
result. They can be called from falcon microcode as instructions, or through IO
ports.</p>
<p>ITLB(physidx) clears the TLB entry corresponding to a specified physical
page. The page is specified as page index. ITLB, however, cannot clear pages
containing secret code - the page has to be reuploaded from scratch with
non-secret data first.</p>
<div class="highlight-python"><pre>void ITLB(b24 physidx) {
        if (!(TLB[physidx].flags &amp; 4)) {
                TLB[physidx].flags = 0;
                TLB[physidx].virt = 0;
        }
}</pre>
</div>
<p>PTLB(physidx) returns the TLB of a given physical page. The format of the
result is:</p>
<ul class="simple">
<li>bits 0-7: 0</li>
<li>bits 8-23: virtual page index</li>
<li>bits 24-26: flags</li>
<li>bits 27-31: 0</li>
</ul>
<div class="highlight-python"><pre>b32 PTLB(b24 physidx) {
        return TLB[physidx].flags &lt;&lt; 24 | TLB[physidx].virt &lt;&lt; 8;
}</pre>
</div>
<p>VTLB(virtaddr) returns the TLB that covers a given virtual <em>address</em>. The
result is:</p>
<ul class="simple">
<li>bits 0-7: physical page index</li>
<li>bits 8-23: 0</li>
<li>bits 24-26: flags, ORed across all matches</li>
<li>bit 30: set if &gt;1 TLB matches [multihit error]</li>
<li>bit 31: set if no TLB matches [no hit error]</li>
</ul>
<div class="highlight-python"><pre>b32 VTLB(b24 virtaddr) {
        phys = 0;
        flags = 0;
        matches = 0;
        for (i = 0; i &lt; UC_CAPS.CODE_PAGES; i++) {
                if (TLB[i].flags &amp;&amp; TLB[i].virt == (virtaddr &gt;&gt; 8 &amp; ((1 &lt;&lt; UC_CAPS2.VM_PAGES_LOG2) - 1))) {
                        flags |= TLB[i].flags;
                        phys = i;
                        matches++;
                }
        }
        res = phys | flags &lt;&lt; 24;
        if (matches == 0)
                res |= 0x80000000;
        if (matches &gt; 1)
                res |= 0x40000000;
        return res;
}</pre>
</div>
<div class="section" id="executing-tlb-operations-through-io">
<span id="falcon-io-tlb"></span><h3><a class="toc-backref" href="#id4">Executing TLB operations through IO</a><a class="headerlink" href="#executing-tlb-operations-through-io" title="Permalink to this headline">¶</a></h3>
<p>The three *TLB operations can be executed by poking TLB_CMD register. For PTLB
and VTLB, the result will then be visible in TLB_CMD_RES register:</p>
<dl class="docutils">
<dt>MMIO 0x140 / I[0x05000]: TLB_CMD</dt>
<dd><p class="first">Runs a given TLB command on write, returns last value written on read.</p>
<ul class="last simple">
<li>bits 0-23: Parameter to the TLB command</li>
<li>bits 24-25: TLB command to execute<ul>
<li>1: ITLB</li>
<li>2: PTLB</li>
<li>3: VTLB</li>
</ul>
</li>
</ul>
</dd>
<dt>MMIO 0x144 / I[0x05100]: TLB_CMD_RES</dt>
<dd>Read-only, returns the result of the last PTLB or VTLB operation launched
through TLB_CMD.</dd>
</dl>
</div>
<div class="section" id="tlb-readout-instructions-ptlb-vtlb">
<span id="falcon-isa-vtlb"></span><span id="falcon-isa-ptlb"></span><h3><a class="toc-backref" href="#id5">TLB readout instructions: ptlb, vtlb</a><a class="headerlink" href="#tlb-readout-instructions-ptlb-vtlb" title="Permalink to this headline">¶</a></h3>
<p>These instructions run the corresponding TLB readout commands and return
their results.</p>
<dl class="docutils">
<dt>Instructions:</dt>
<dd><table border="1" class="first last docutils">
<colgroup>
<col width="10%" />
<col width="44%" />
<col width="24%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Description</th>
<th class="head">Present on</th>
<th class="head">Subopcode</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ptlb</td>
<td>run PTLB operation</td>
<td>v3+ units</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>vtlb</td>
<td>run VTLB operation</td>
<td>v3+ units</td>
<td>3</td>
</tr>
</tbody>
</table>
</dd>
<dt>Instruction class:</dt>
<dd>unsized</dd>
<dt>Operands:</dt>
<dd>DST, SRC</dd>
<dt>Forms:</dt>
<dd><table border="1" class="first last docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Form</th>
<th class="head">Opcode</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>R1, R2</td>
<td>fe</td>
</tr>
</tbody>
</table>
</dd>
<dt>Operation:</dt>
<dd><div class="first last highlight-python"><pre>if (op == ptlb)
        DST = PTLB(SRC);
else
        DST = VTLB(SRC);</pre>
</div>
</dd>
</dl>
</div>
<div class="section" id="tlb-invalidation-instruction-itlb">
<span id="falcon-isa-itlb"></span><h3><a class="toc-backref" href="#id6">TLB invalidation instruction: itlb</a><a class="headerlink" href="#tlb-invalidation-instruction-itlb" title="Permalink to this headline">¶</a></h3>
<p>This instructions runs the ITLB command.</p>
<dl class="docutils">
<dt>Instructions:</dt>
<dd><table border="1" class="first last docutils">
<colgroup>
<col width="10%" />
<col width="44%" />
<col width="24%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Description</th>
<th class="head">Present on</th>
<th class="head">Subopcode</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>itlb</td>
<td>run ITLB operation</td>
<td>v3+ units</td>
<td>8</td>
</tr>
</tbody>
</table>
</dd>
<dt>Instruction class:</dt>
<dd>unsized</dd>
<dt>Operands:</dt>
<dd>SRC</dd>
<dt>Forms:</dt>
<dd><table border="1" class="first last docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Form</th>
<th class="head">Opcode</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>R2</td>
<td>f9</td>
</tr>
</tbody>
</table>
</dd>
<dt>Operation:</dt>
<dd><div class="first last highlight-python"><div class="highlight"><pre><span class="n">ITLB</span><span class="p">(</span><span class="n">SRC</span><span class="p">);</span>
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="vm-usage-on-code-execution">
<span id="falcon-trap-vm"></span><h2><a class="toc-backref" href="#id7">VM usage on code execution</a><a class="headerlink" href="#vm-usage-on-code-execution" title="Permalink to this headline">¶</a></h2>
<p>Whenever instruction fetch is attempted, the VTLB operation is done on fetch
address. If it returns no-hit or multihit error, a trap is generated and the
$tstatus reason field is set to 0xa [for no-hit] or 0xb [for multihit]. Note
that, if the faulting instruction happens to cross a page bounduary and the
second page triggered a fault, the $pc register saved in $tstatus wiill not
point to the page that faulted.</p>
<p>If no error was triggered, flag 0 [usable] is checked. If it&#8217;s set, the access
is finished using the physical page found by VTLB. If usable isn&#8217;t set, but
flag 1 [busy] is set, the fetch is paused and will be retried when TLBs are
modified in any way. Otherwise, flag 2 [secret] must be the only flag set.
In this case, a switch to authenticated mode is attempted - see <a class="reference internal" href="crypt.html#falcon-crypt"><em>Cryptographic coprocessor</em></a>
for details.</p>
</div>
<div class="section" id="code-upload-and-peeking">
<span id="falcon-io-code"></span><h2><a class="toc-backref" href="#id8">Code upload and peeking</a><a class="headerlink" href="#code-upload-and-peeking" title="Permalink to this headline">¶</a></h2>
<p>Code can be uploaded in two ways: direct upload via a window in IO space, or
by an xfer [see <a class="reference internal" href="xfer.html#falcon-xfer"><em>Code/data xfers to/from external memory</em></a>]. The IO registers relevant are:</p>
<dl class="docutils">
<dt>MMIO 0x180 / I[0x06000]: CODE_INDEX</dt>
<dd><p class="first">Selects the place in code segment accessed by CODE reg.</p>
<ul class="simple">
<li>bits 2-15: bits 2-15 of the physical code address to poke</li>
<li>bit 24: write autoincrement flag: if set, every write to corresponding CODE
register increments the address by 4</li>
<li>bit 25: read autoincrement flag: like 24, but for reads</li>
<li>bit 28: secret: if set, will attempt a switch to secret lockdown on next
CODE write attempt and will mark uploaded code as secret.</li>
<li>bit 29: secret lockdown [RO]: if set, currently in secret lockdown mode
- CODE_INDEX cannot be modified manually until a complete page is
uploaded and will auto-increment on CODE writes irrespective of
write autoincrement flag. Reads will fail and won&#8217;t auto-increment.</li>
<li>bit 30: secret fail [RO]: if set, entering secret lockdown failed due to
attempt to start upload from not page aligned address.</li>
<li>bit 31: secret reset scrubber active [RO]: if set, the window isn&#8217;t
currently usable because the reset scrubber is busy.</li>
</ul>
<p class="last">See <a class="reference internal" href="crypt.html#falcon-crypt"><em>Cryptographic coprocessor</em></a> for the secret stuff.</p>
</dd>
<dt>MMIO 0x184 / I[0x06100]: CODE</dt>
<dd>Writes execute CST(CODE_INDEX &amp; 0xfffc, value); and increment the address
if write autoincrement is enabled or secret lockdown is in effect. Reads
return the contents of code segment at physical address CODE_INDEX &amp; 0xfffc
and increment if read autoincrement is enabled and secret lockdown is not
in effect. Attempts to read from physical code pages with the secret flag
will return 0xdead5ec1 instead of the real contents. The values read/written
are 32-bit LE numbers corresponding to 4 bytes in the code segment.</dd>
<dt>MMIO 0x188 / I[0x06200]: CODE_VIRT</dt>
<dd>Selects the virtual page index for uploaded code. The index is sampled when
writing word 0 of each page.</dd>
</dl>
<p>CST is defined thus:</p>
<div class="highlight-python"><pre>void CST(addr, value) {
        physidx = addr &gt;&gt; 8;
        // if secret lockdown needed for the page, but starting from non-0 address, fail.
        if ((addr &amp; 0xfc) != 0 &amp;&amp; (CODE_INDEX.secret || TLB[physidx] &amp; 4) &amp;&amp; !CODE_INDEX.secret_lockdown)
                CODE_INDEX.secret_fail = 1;
        if (CODE_INDEX.secret_fail || CODE_INDEX.secret_scrubber_active) {
                // nothing.
        } else {
                enter_lockdown = 0;
                exit_lockdown = 0;
                if ((addr &amp; 0xfc) == 0) {
                        // if first word uploaded...
                        if (CODE_INDEX.secret || TLB[physidx].flags &amp; 4) {
                                // if uploading secret code, or uploading code to replace secret code, enter lockdown
                                enter_lockdown = 1;
                        }
                        // store virt addr
                        TLB[physid].virt = CODE_VIRT;
                        // clear usable flag, set busy flag
                        TLB[physid].flags = 2;
                        if (CODE_INDEX.secret)
                                TLB[physid].flags |= 4;
                }
                code[addr] = value; // write 4 bytes to code segment
                if ((addr &amp; 0xfc) == 0xfc) {
                        // last word uploaded, page now complete.
                        exit_lockdown = 1;
                        // clear busy, set usable or secret
                        if (CODE_INDEX.secret)
                                TLB[physid].flags = 4;
                        else
                                TLB[physid].flags = 1;
                }
                if (CODE_INDEX.write_autoincrement || CODE_INDEX.secret_lockdown)
                        addr += 4;
                if (enter_lockdown)
                        CODE_INDEX.secret_lockdown = 1;
                if (exit_lockdown)
                        CODE_INDEX.secret_lockdown = 0;
}</pre>
</div>
<p>In summary, to upload a single page of code:</p>
<ol class="arabic simple">
<li>Set CODE_INDEX to physical_addr | 0x1000000 [and | 0x10000000 if uploading secret code]</li>
<li>Set CODE_VIRT to virtual page index it should be mapped at</li>
<li>Write 0x40 words to CODE</li>
</ol>
<p>Uploading code via xfers will set TLB[physid].virt = ext_offset &gt;&gt; 8 and
TLB[physid].flags = (secret ? 6 : 2) right after the xfer is started, then
set TLB[physid].flags = (secret ? 4 : 1) when it&#8217;s complete. See <a class="reference internal" href="xfer.html#falcon-xfer"><em>Code/data xfers to/from external memory</em></a>
for more information.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Code virtual memory</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#tlb-operations-ptlb-vtlb-itlb">TLB operations: PTLB, VTLB, ITLB</a><ul>
<li><a class="reference internal" href="#executing-tlb-operations-through-io">Executing TLB operations through IO</a></li>
<li><a class="reference internal" href="#tlb-readout-instructions-ptlb-vtlb">TLB readout instructions: ptlb, vtlb</a></li>
<li><a class="reference internal" href="#tlb-invalidation-instruction-itlb">TLB invalidation instruction: itlb</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vm-usage-on-code-execution">VM usage on code execution</a></li>
<li><a class="reference internal" href="#code-upload-and-peeking">Code upload and peeking</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="proc.html"
                        title="previous chapter">Processor control</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="intr.html"
                        title="next chapter">Interrupts</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/falcon/vm.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="intr.html" title="Interrupts"
             >next</a> |</li>
        <li class="right" >
          <a href="proc.html" title="Processor control"
             >previous</a> |</li>
        <li><a href="../index.html">envytools git documentation</a> &raquo;</li>
          <li><a href="index.html" >falcon microprocessor</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Marcin Kościelnicki.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>